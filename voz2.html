<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Harmony & Rhythm History Pro</title>
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ffcc00;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --accent: #4f46e5;
            --success: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
        }

        .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        /* Displays Grandes */
        .display-big {
            font-size: 58px;
            font-weight: 800;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px 0;
        }

        #display-note {
            color: #ffffff;
        }

        #display-chord {
            color: var(--primary);
        }

        #bpm-display {
            color: var(--secondary);
        }

        .freq-info {
            font-family: monospace;
            font-size: 1.2rem;
            color: #94a3b8;
            margin-bottom: 10px;
        }

        /* Medidor de Afina√ß√£o */
        .tuner-container {
            position: relative;
            width: 100%;
            height: 12px;
            background: #334155;
            border-radius: 6px;
            margin: 20px 0;
        }

        .center-line {
            position: absolute;
            left: 50%;
            width: 2px;
            height: 20px;
            background: var(--success);
            top: -4px;
            z-index: 1;
        }

        #needle {
            position: absolute;
            left: 50%;
            width: 4px;
            height: 20px;
            background: var(--primary);
            top: -4px;
            border-radius: 2px;
            transform: translateX(-50%);
            transition: left 0.1s ease-out;
            z-index: 2;
        }

        /* Hist√≥rico */
        .history-list {
            height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #0f172a;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        /* Controles / Seletores */
        .settings-grid {
            text-align: left;
            display: grid;
            gap: 12px;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }

            .control-group label span {
                color: var(--primary);
                font-weight: bold;
            }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .btn-main {
            grid-column: 1 / -1;
            background: var(--accent);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

            .btn-main.active {
                background: #ef4444;
            }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 10px;">Pitch, Harmony & Rhythm Pro</h2>

    <div class="dashboard">

        <!-- Bloco 1: Detec√ß√£o de Nota e Acorde -->
        <div class="card">
            <div class="label" id="current-key">Tom: Aguardando...</div>
            <div id="display-note" class="display-big">--</div>
            <div class="freq-info"><span id="frequency">0.00</span> Hz</div>

            <div class="tuner-container">
                <div class="center-line"></div>
                <div id="needle"></div>
            </div>

            <hr style="border: 0; border-top: 1px solid #334155; margin: 15px 0;">

            <div id="display-chord" class="display-big">-</div>
            <div class="label">Acorde Sugerido</div>
        </div>

        <!-- Bloco 2: Configura√ß√µes T√©cnicas (OS SELETORES) -->
        <div class="card">
            <div class="label">Ajustes do Detector</div>
            <div class="settings-grid">
                <div class="control-group">
                    <label>Sensibilidade (Ru√≠do): <span id="v-noise">0.02</span></label>
                    <input type="range" id="noise" min="0.001" max="0.1" step="0.001" value="0.02">
                </div>
                <div class="control-group">
                    <label>Freq. M√≠nima: <span id="v-min">80</span> Hz</label>
                    <input type="range" id="min-freq" min="40" max="200" step="1" value="80">
                </div>
                <div class="control-group">
                    <label>Freq. M√°xima: <span id="v-max">1100</span> Hz</label>
                    <input type="range" id="max-freq" min="500" max="2000" step="10" value="1100">
                </div>
                <div class="control-group">
                    <label>Suaviza√ß√£o: <span id="v-smooth">5</span></label>
                    <input type="range" id="smooth" min="1" max="20" step="1" value="5">
                </div>
                <div class="control-group">
                    <label>Dura√ß√£o M√≠nima: <span id="v-duration">100</span> ms</label>
                    <input type="range" id="duration" min="0" max="1000" step="50" value="100">
                </div>
            </div>
        </div>

        <!-- Bloco 3: Ritmo e Hist√≥rico -->
        <div class="card">
            <div class="label">Ritmo Est√°tico</div>
            <div id="bpm-display" class="display-big">0</div>
            <div class="label" id="note-type-label">Pulsa√ß√£o Din√¢mica</div>

            <div class="label" style="margin-top: 20px;">Hist√≥rico Recente</div>
            <div id="history-list" class="history-list"></div>
        </div>

        <button id="start-btn" class="btn-main">Iniciar Capta√ß√£o</button>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO E ESTADO ---
        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const diatonicScales = Array.from({ length: 12 }, (_, root) => [0, 2, 4, 5, 7, 9, 11].map(i => (root + i) % 12));

        let config = {
            noiseThreshold: 0.02,
            minFreq: 80,
            maxFreq: 1100,
            smoothing: 5,
            minDuration: 100
        };

        let audioCtx, analyser, dataArray;
        let isRunning = false;
        let pitchHistory = [];
        let harmonyHistory = [];
        let lastStableNoteName = "";
        let noteStartTime = 0;
        let currentTonality = 0;

        // R√≠tmico
        let lastNoteTime = 0;
        let pulseMs = 0;

        // --- UI ELEMENTS ---
        const ui = {
            btn: document.getElementById('start-btn'),
            note: document.getElementById('display-note'),
            chord: document.getElementById('display-chord'),
            freq: document.getElementById('frequency'),
            bpm: document.getElementById('bpm-display'),
            needle: document.getElementById('needle'),
            history: document.getElementById('history-list'),
            key: document.getElementById('current-key'),
            noteType: document.getElementById('note-type-label'),
            // Sliders
            inNoise: document.getElementById('noise'),
            inMin: document.getElementById('min-freq'),
            inMax: document.getElementById('max-freq'),
            inSmooth: document.getElementById('smooth'),
            inDuration: document.getElementById('duration'),
            // Labels Valores
            lNoise: document.getElementById('v-noise'),
            lMin: document.getElementById('v-min'),
            lMax: document.getElementById('v-max'),
            lSmooth: document.getElementById('v-smooth'),
            lDuration: document.getElementById('v-duration')
        };

        // --- ATUALIZA√á√ÉO DIN√ÇMICA DOS SELETORES ---
        function updateConfigs() {
            config.noiseThreshold = parseFloat(ui.inNoise.value);
            config.minFreq = parseInt(ui.inMin.value);
            config.maxFreq = parseInt(ui.inMax.value);
            config.smoothing = parseInt(ui.inSmooth.value);
            config.minDuration = parseInt(ui.inDuration.value);

            ui.lNoise.innerText = config.noiseThreshold;
            ui.lMin.innerText = config.minFreq;
            ui.lMax.innerText = config.maxFreq;
            ui.lSmooth.innerText = config.smoothing;
            ui.lDuration.innerText = config.minDuration;
        }
        [ui.inNoise, ui.inMin, ui.inMax, ui.inSmooth, ui.inDuration].forEach(el => el.oninput = updateConfigs);

        // --- L√ìGICA DE √ÅUDIO ---
        ui.btn.onclick = async () => {
            if (isRunning) { location.reload(); return; }
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);
                dataArray = new Float32Array(analyser.fftSize);
                isRunning = true;
                ui.btn.innerText = "Parar Detec√ß√£o";
                ui.btn.classList.add('active');
                update();
            } catch (err) { alert("Erro: Permita o acesso ao microfone."); }
        };

        function update() {
            if (!isRunning) return;
            analyser.getFloatTimeDomainData(dataArray);
            let pitch = autoCorrelate(dataArray, audioCtx.sampleRate);

            if (pitch !== -1 && pitch >= config.minFreq && pitch <= config.maxFreq) {
                const rawNoteData = getNote(pitch);
                const now = performance.now();

                // Checa se a nota mudou para resetar o tempo de dura√ß√£o m√≠nima
                if (rawNoteData.name !== lastStableNoteName) {
                    lastStableNoteName = rawNoteData.name;
                    noteStartTime = now;
                }

                // S√≥ processa se a nota for sustentada pelo tempo m√≠nimo configurado
                if (now - noteStartTime >= config.minDuration) {
                    pitchHistory.push(pitch);
                    if (pitchHistory.length > config.smoothing) pitchHistory.shift();
                    const avgPitch = pitchHistory.reduce((a, b) => a + b) / pitchHistory.length;

                    const noteData = getNote(avgPitch);
                    ui.note.innerText = noteData.name;
                    ui.freq.innerText = avgPitch.toFixed(2);
                    ui.needle.style.left = `${50 + noteData.cents}%`;
                    ui.note.style.color = Math.abs(noteData.cents) < 10 ? "var(--success)" : "#fff";

                    // Dispara l√≥gica r√≠tmica e harm√¥nica quando uma nota se estabiliza
                    handleStableNote(noteData.name);
                }
            } else {
                if (pitchHistory.length > 0) pitchHistory.shift();
            }
            requestAnimationFrame(update);
        }

        let lastTrackedNote = "";
        function handleStableNote(noteName) {
            if (noteName === lastTrackedNote) return;
            lastTrackedNote = noteName;

            const now = Date.now();
            const noteIndex = noteStrings.indexOf(noteName);

            // 1. Ritmo
            const rhythm = processRhythm(now);

            if (rhythm) {
                // 2. Hist√≥rico
                addNoteToHistory(noteName, rhythm);

                // 3. Tonalidade
                harmonyHistory.push(noteIndex);
                if (harmonyHistory.length > 15) harmonyHistory.shift();
                detectTonality();

                // 4. Acorde (Sugest√£o baseada na dura√ß√£o)
                if (rhythm.name === "M√≠nima" || rhythm.name === "Semibreve" || rhythm.name === "Sem√≠nima") {
                    ui.chord.innerText = getChordFromField(noteIndex, currentTonality);
                }
            }
        }

        // --- RITMO E CAMPO HARM√îNICO ---
        function processRhythm(now) {
            if (lastNoteTime === 0) { lastNoteTime = now; return { name: "In√≠cio", icon: "‚ñ∂" }; }
            const interval = now - lastNoteTime;
            if (interval < 150) return null;

            let result = classifyNote(interval);
            ui.bpm.innerText = Math.round(60000 / pulseMs);
            ui.noteType.innerText = `${result.icon} ${result.name}`;

            lastNoteTime = now;
            return result;
        }

        function classifyNote(interval) {
            if (pulseMs === 0 || interval > 4000) { pulseMs = interval; return { name: "Sem√≠nima", icon: "ùÖü" }; }
            let ratio = interval / pulseMs;
            if (ratio >= 3.2) return { name: "Semibreve", icon: "ùÖù" };
            if (ratio >= 1.7) return { name: "M√≠nima", icon: "ùÖû" };
            if (ratio >= 0.8) { pulseMs = (pulseMs * 0.8 + interval * 0.2); return { name: "Sem√≠nima", icon: "ùÖü" }; }
            if (ratio >= 0.4) return { name: "Colcheia", icon: "ùÖ†" };
            return { name: "Semicolcheia", icon: "ùÖ°" };
        }

        function detectTonality() {
            let bestScale = currentTonality;
            let maxScore = -1;
            diatonicScales.forEach((scale, root) => {
                const score = harmonyHistory.filter(n => scale.includes(n)).length;
                if (score > maxScore) { maxScore = score; bestScale = root; }
            });
            currentTonality = bestScale;
            ui.key.innerText = `Tom: ${noteStrings[currentTonality]}`;
        }

        function getChordFromField(note, tonality) {
            const degree = (note - tonality + 12) % 12;
            const field = {
                0: noteStrings[tonality],
                2: noteStrings[(tonality + 2) % 12] + "m",
                4: noteStrings[(tonality + 4) % 12] + "m",
                5: noteStrings[(tonality + 5) % 12],
                7: noteStrings[(tonality + 7) % 12],
                9: noteStrings[(tonality + 9) % 12] + "m",
                11: noteStrings[(tonality + 11) % 12] + "¬∫"
            };
            return field[degree] || noteStrings[note];
        }

        function addNoteToHistory(noteName, rhythm) {
            const item = document.createElement('div');
            item.className = 'history-item';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            item.innerHTML = `
                    <span style="color:var(--primary); font-weight:bold;">${noteName}</span>
                    <span style="color:var(--secondary)">${rhythm.icon} ${rhythm.name}</span>
                    <span style="color:#475569; font-size:10px;">${time}</span>
                `;
            ui.history.prepend(item);
            if (ui.history.children.length > 20) ui.history.removeChild(ui.history.lastChild);
        }

        // --- ALGORITMOS BASE ---
        function autoCorrelate(buffer, sampleRate) {
            let rms = 0;
            for (let i = 0; i < buffer.length; i++) rms += buffer[i] * buffer[i];
            rms = Math.sqrt(rms / buffer.length);
            if (rms < config.noiseThreshold) return -1;

            let minPeriod = sampleRate / config.maxFreq;
            let maxPeriod = sampleRate / config.minFreq;
            let bestOffset = -1;
            let bestCorrelation = 0;

            for (let offset = Math.floor(minPeriod); offset < Math.ceil(maxPeriod); offset++) {
                let correlation = 0;
                for (let i = 0; i < buffer.length - offset; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / buffer.length);
                if (correlation > bestCorrelation) { bestCorrelation = correlation; bestOffset = offset; }
            }
            return bestCorrelation > 0.9 ? sampleRate / bestOffset : -1;
        }

        function getNote(frequency) {
            const semitones = 12 * Math.log2(frequency / 440);
            const noteNum = Math.round(semitones) + 69;
            const cents = Math.floor((semitones - Math.round(semitones)) * 100);
            return { name: noteStrings[noteNum % 12], cents: cents };
        }
    </script>
</body>
</html>