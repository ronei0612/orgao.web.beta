<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Harmony & Rhythm Pro</title>
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ffcc00;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --accent: #4f46e5;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1100px;
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
        }

        /* Displays Grandes */
        .big-value {
            font-size: 64px;
            font-weight: 800;
            margin: 10px 0;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #display-note {
            color: #fff;
        }

        #display-chord {
            color: var(--primary);
        }

        #bpm-display {
            color: var(--secondary);
        }

        .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #94a3b8;
        }

        /* Tuner / Agulha */
        .tuner-box {
            margin: 20px 0;
            position: relative;
            height: 10px;
            background: #334155;
            border-radius: 5px;
        }

        #needle {
            position: absolute;
            left: 50%;
            width: 4px;
            height: 20px;
            background: var(--primary);
            top: -5px;
            transform: translateX(-50%);
            transition: left 0.1s ease-out;
            border-radius: 2px;
        }

        /* Hist√≥rico */
        .history-panel {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .history-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            background: #0f172a;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            animation: fadeIn 0.3s ease;
        }

        /* Controles */
        .controls {
            text-align: left;
            font-size: 13px;
        }

        .control-group {
            margin-bottom: 10px;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
        }

        .btn-main {
            grid-column: 1 / -1;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }

            .btn-main.active {
                background: #ef4444;
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 5px;">Music Analysis Pro</h2>
    <p style="color: #94a3b8; margin-bottom: 25px;">Detec√ß√£o de Notas, Acordes e Ritmo via Microfone</p>

    <div class="dashboard">

        <!-- Bloco Principal de Notas -->
        <div class="card">
            <div class="label" id="current-key">Aguardando √°udio...</div>
            <div id="display-note" class="big-value">--</div>
            <div class="label">Nota Detectada</div>

            <div class="tuner-box">
                <div style="position: absolute; left: 50%; width: 2px; height: 10px; background: white; z-index: 1;"></div>
                <div id="needle"></div>
            </div>

            <div id="display-chord" class="big-value">-</div>
            <div class="label">Sugest√£o de Acorde</div>
        </div>

        <!-- Bloco de Ritmo -->
        <div class="card">
            <div class="label">BPM Estimado</div>
            <div id="bpm-display" class="big-value">0</div>
            <div class="label" id="note-type-label">Sil√™ncio</div>

            <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0;">

            <div class="controls">
                <div class="control-group">
                    <label>Sensibilidade: <span id="v-noise">0.02</span></label>
                    <input type="range" id="noise" min="0.001" max="0.1" step="0.001" value="0.02">
                </div>
                <div class="control-group">
                    <label>Suaviza√ß√£o: <span id="v-smooth">5</span></label>
                    <input type="range" id="smooth" min="1" max="15" value="5">
                </div>
            </div>
        </div>

        <!-- Bloco de Hist√≥rico -->
        <div class="card history-panel">
            <div class="label">Hist√≥rico de Performance</div>
            <div id="history-list" class="history-list"></div>
        </div>

        <button id="start-btn" class="btn-main">Iniciar Capta√ß√£o</button>

    </div>

    <script>
        // --- CONFIGURA√á√ïES E ESTADOS ---
        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const diatonicScales = Array.from({ length: 12 }, (_, root) => [0, 2, 4, 5, 7, 9, 11].map(i => (root + i) % 12));

        let config = { noise: 0.02, smoothing: 5, minFreq: 60, maxFreq: 1200 };
        let audioCtx, analyser, dataArray;
        let isRunning = false;

        let pitchHistory = [];
        let harmonyHistory = [];
        let lastStableNote = "";
        let noteStartTime = 0;
        let currentTonality = 0;

        // Ritmo
        let lastNoteTime = 0;
        let pulseMs = 0;

        // UI Elements
        const ui = {
            note: document.getElementById('display-note'),
            chord: document.getElementById('display-chord'),
            bpm: document.getElementById('bpm-display'),
            key: document.getElementById('current-key'),
            needle: document.getElementById('needle'),
            history: document.getElementById('history-list'),
            noteType: document.getElementById('note-type-label'),
            btn: document.getElementById('start-btn')
        };

        // --- INICIALIZA√á√ÉO DO √ÅUDIO ---
        ui.btn.onclick = async () => {
            if (isRunning) { location.reload(); return; }

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);
                dataArray = new Float32Array(analyser.fftSize);

                isRunning = true;
                ui.btn.innerText = "Parar Sistema";
                ui.btn.classList.add('active');
                update();
            } catch (e) { alert("Erro ao acessar microfone."); }
        };

        // --- LOOP DE PROCESSAMENTO ---
        function update() {
            if (!isRunning) return;

            analyser.getFloatTimeDomainData(dataArray);
            let pitch = autoCorrelate(dataArray, audioCtx.sampleRate);

            if (pitch !== -1 && pitch >= config.minFreq && pitch <= config.maxFreq) {
                const noteData = getNote(pitch);

                // Suaviza√ß√£o
                pitchHistory.push(pitch);
                if (pitchHistory.length > config.smoothing) pitchHistory.shift();
                const avgPitch = pitchHistory.reduce((a, b) => a + b) / pitchHistory.length;
                const stableNoteData = getNote(avgPitch);

                // UI Imediata (Tuner)
                ui.note.innerText = stableNoteData.name;
                ui.needle.style.left = `${50 + stableNoteData.cents}%`;
                ui.note.style.color = Math.abs(stableNoteData.cents) < 10 ? "var(--primary)" : "#fff";

                // Detec√ß√£o de Nova Nota (Evento R√≠tmico/Harm√¥nico)
                if (stableNoteData.name !== lastStableNote) {
                    handleNewNote(stableNoteData.name);
                    lastStableNote = stableNoteData.name;
                }
            } else {
                // Sil√™ncio
                if (pitchHistory.length > 0) pitchHistory.shift();
            }

            requestAnimationFrame(update);
        }

        // --- L√ìGICA DE M√öSICA (INTEGRA√á√ÉO) ---
        function handleNewNote(noteName) {
            const now = Date.now();
            const noteIndex = noteStrings.indexOf(noteName);

            // 1. Processar Ritmo
            const rhythm = processRhythm(now);

            // 2. Adicionar ao Hist√≥rico
            if (rhythm) {
                addNoteToHistory(noteName, rhythm);

                // 3. Atualizar Tonalidade
                harmonyHistory.push(noteIndex);
                if (harmonyHistory.length > 15) harmonyHistory.shift();
                detectTonality();

                // 4. Analisar Acorde (Baseado no Campo Harm√¥nico do Tom atual)
                // Se for uma nota longa (M√≠nima/Semibreve), sugerimos o acorde
                if (rhythm.name === "M√≠nima" || rhythm.name === "Semibreve" || rhythm.name === "Sem√≠nima") {
                    const suggestedChord = getChordFromField(noteIndex, currentTonality);
                    ui.chord.innerText = suggestedChord;
                }
            }
        }

        function processRhythm(now) {
            if (lastNoteTime === 0) {
                lastNoteTime = now;
                return { name: "In√≠cio", icon: "‚ñ∂" };
            }

            const interval = now - lastNoteTime;
            if (interval < 150) return null; // Debounce para ru√≠do

            let result = classifyNote(interval);

            if (pulseMs > 0) {
                ui.bpm.innerText = Math.round(60000 / pulseMs);
                ui.noteType.innerText = `${result.icon} ${result.name}`;
            }

            lastNoteTime = now;
            return result;
        }

        function classifyNote(interval) {
            if (pulseMs === 0 || interval > 3000) {
                pulseMs = interval;
                return { name: "Sem√≠nima", icon: "ùÖü" };
            }

            let ratio = interval / pulseMs;
            if (ratio >= 3.2) return { name: "Semibreve", icon: "ùÖù" };
            if (ratio >= 1.7) return { name: "M√≠nima", icon: "ùÖû" };
            if (ratio >= 0.8) {
                pulseMs = (pulseMs * 0.7 + interval * 0.3); // Ajuste din√¢mico do BPM
                return { name: "Sem√≠nima", icon: "ùÖü" };
            }
            if (ratio >= 0.4) return { name: "Colcheia", icon: "ùÖ†" };
            return { name: "Semicolcheia", icon: "ùÖ°" };
        }

        function detectTonality() {
            if (harmonyHistory.length < 5) return;

            let bestScale = currentTonality;
            let maxScore = -1;

            diatonicScales.forEach((scale, root) => {
                const score = harmonyHistory.filter(n => scale.includes(n)).length;
                if (score > maxScore) {
                    maxScore = score;
                    bestScale = root;
                }
            });

            currentTonality = bestScale;
            ui.key.innerText = `Tom: ${noteStrings[currentTonality]}`;
        }

        function getChordFromField(note, tonality) {
            const degree = (note - tonality + 12) % 12;
            const field = {
                0: noteStrings[tonality],              // I
                2: noteStrings[(tonality + 2) % 12] + "m",   // ii
                4: noteStrings[(tonality + 4) % 12] + "m",   // iii
                5: noteStrings[(tonality + 5) % 12],       // IV
                7: noteStrings[(tonality + 7) % 12],       // V
                9: noteStrings[(tonality + 9) % 12] + "m",   // vi
                11: noteStrings[(tonality + 11) % 12] + "¬∫"  // vii¬∫
            };
            return field[degree] || noteStrings[note];
        }

        function addNoteToHistory(noteName, rhythm) {
            const item = document.createElement('div');
            item.className = 'history-item';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            item.innerHTML = `
                    <b style="color:var(--primary)">${noteName}</b>
                    <span style="color:var(--secondary)">${rhythm.icon} ${rhythm.name}</span>
                    <small style="color:#475569">${time}</small>
                `;

            ui.history.prepend(item);
            if (ui.history.children.length > 20) ui.history.removeChild(ui.history.lastChild);
        }

        // --- ALGORITMOS DE √ÅUDIO ---
        function autoCorrelate(buffer, sampleRate) {
            let rms = 0;
            for (let i = 0; i < buffer.length; i++) rms += buffer[i] * buffer[i];
            rms = Math.sqrt(rms / buffer.length);
            if (rms < config.noise) return -1;

            let minPeriod = sampleRate / config.maxFreq;
            let maxPeriod = sampleRate / config.minFreq;
            let bestOffset = -1;
            let bestCorrelation = 0;

            for (let offset = Math.floor(minPeriod); offset < Math.ceil(maxPeriod); offset++) {
                let correlation = 0;
                for (let i = 0; i < buffer.length - offset; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / buffer.length);
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }
            return bestCorrelation > 0.9 ? sampleRate / bestOffset : -1;
        }

        function getNote(frequency) {
            const semitones = 12 * Math.log2(frequency / 440);
            const noteNum = Math.round(semitones) + 69;
            const cents = Math.floor((semitones - Math.round(semitones)) * 100);
            return { name: noteStrings[noteNum % 12], cents: cents };
        }

        // Sliders
        document.getElementById('noise').oninput = function () {
            config.noise = parseFloat(this.value);
            document.getElementById('v-noise').innerText = this.value;
        };
        document.getElementById('smooth').oninput = function () {
            config.smoothing = parseInt(this.value);
            document.getElementById('v-smooth').innerText = this.value;
        };
    </script>
</body>
</html>