<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detector de Harmonia Vocal PRO</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-color: #00ffcc;
            --chord-color: #ffcc00;
            --btn-start: #1db954;
            --btn-stop: #ff4d4d;
            --card: #1e1e1e;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            text-align: center;
            width: 90%;
            max-width: 500px;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--chord-color);
        }

        #bpm-val {
            color: var(--accent-color);
        }

        .note-display {
            font-size: 5rem;
            font-weight: 800;
            color: #fff;
            margin: 10px 0;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rhythm-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #333;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .tuner-container {
            width: 100%;
            margin-bottom: 30px;
        }

        .tuner-bar {
            height: 4px;
            background: #333;
            position: relative;
            border-radius: 2px;
        }

        .tuner-dot {
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.1s;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: var(--btn-start);
            cursor: pointer;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
            transition: all 0.3s;
        }

            .mic-button.listening {
                background: var(--btn-stop);
                animation: pulse 1.5s infinite;
            }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(255, 77, 77, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);
            }
        }

        .freq-text {
            font-family: monospace;
            color: #666;
            font-size: 0.8rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label" id="key-label">Tom Estimado</span>
                <span class="stat-value" id="keyVal">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">BPM Vocal</span>
                <span class="stat-value" id="bpm-val">0</span>
            </div>
        </div>

        <div class="stat-label">Acorde Recomendado</div>
        <div class="stat-value" style="font-size: 3rem; margin-bottom: 10px;" id="chordVal">--</div>

        <div class="rhythm-badge" id="rhythm-val">Aguardando ritmo...</div>

        <div class="note-display" id="note">--</div>

        <div class="tuner-container">
            <div class="tuner-bar">
                <div class="tuner-dot" id="indicator"></div>
            </div>
        </div>

        <button class="mic-button" id="micBtn">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
            </svg>
        </button>
        <div class="freq-text" id="freq">Sil칡ncio</div>
    </div>

    <script>
        const cipherNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const diatonicScales = Array.from({ length: 12 }, (_, root) => [0, 2, 4, 5, 7, 9, 11].map(i => (root + i) % 12));

        let audioContext, analyser, isListening = false;
        let harmonyHistory = [];
        let currentTonality = 0;
        let lastNoteTime = 0;
        let pulseMs = 0;
        let lastStableNote = -1;
        let buffer = [];

        const elements = {
            note: document.getElementById("note"),
            freq: document.getElementById("freq"),
            key: document.getElementById("keyVal"),
            chord: document.getElementById("chordVal"),
            bpm: document.getElementById("bpm-val"),
            rhythm: document.getElementById("rhythm-val"),
            indicator: document.getElementById("indicator"),
            btn: document.getElementById("micBtn")
        };

        elements.btn.onclick = toggleMic;

        async function toggleMic() {
            if (isListening) {
                isListening = false;
                location.reload(); // Simplificado para resetar
                return;
            }
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);
                isListening = true;
                elements.btn.classList.add("listening");
                detect();
            } catch (e) { alert("Microfone n칚o acess칤vel."); }
        }

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length;
            let rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            if (Math.sqrt(rms / SIZE) < 0.02) return -1;

            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++)
                for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];

            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) {
                if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
            }
            return sampleRate / maxpos;
        }

        function detect() {
            if (!isListening) return;
            const buf = new Float32Array(analyser.fftSize);
            analyser.getFloatTimeDomainData(buf);
            const pitch = autoCorrelate(buf, audioContext.sampleRate);

            if (pitch !== -1 && pitch > 60 && pitch < 1200) {
                const noteNum = 12 * (Math.log(pitch / 440) / Math.log(2)) + 69;
                const noteIndex = Math.round(noteNum) % 12;

                // Estabiliza칞칚o de nota
                buffer.push(noteIndex);
                if (buffer.length > 5) buffer.shift();
                const stable = buffer.every(v => v === buffer[0]);

                if (stable && noteIndex !== lastStableNote) {
                    onNoteStart(noteIndex);
                    lastStableNote = noteIndex;
                }

                updateTuner(pitch, Math.round(noteNum));
                elements.note.innerText = cipherNames[noteIndex];
                elements.freq.innerText = Math.round(pitch) + " Hz";
            }
            requestAnimationFrame(detect);
        }

        function onNoteStart(noteIndex) {
            const now = Date.now();

            // L칩gica R칤tmica e BPM
            if (lastNoteTime > 0) {
                const interval = now - lastNoteTime;
                if (interval > 150) { // Ignora repiques r치pidos
                    const rhythm = classifyRhythm(interval);
                    elements.rhythm.innerText = `${rhythm.icon} ${rhythm.name}`;
                    if (pulseMs > 0) elements.bpm.innerText = Math.round(60000 / pulseMs);

                    // Se for uma nota longa (M칤nima/Semibreve), atualiza o acorde
                    if (rhythm.name === "M칤nima" || rhythm.name === "Semibreve") {
                        updateChord(noteIndex);
                    }
                }
            }
            lastNoteTime = now;

            // L칩gica de Tom (An치lise de Hist칩rico)
            harmonyHistory.push(noteIndex);
            if (harmonyHistory.length > 20) harmonyHistory.shift();
            updateTonality();
        }

        function classifyRhythm(interval) {
            if (pulseMs === 0) { pulseMs = interval; return { name: "Sem칤nima", icon: "洧" }; }
            let ratio = interval / pulseMs;

            if (ratio < 0.4) { pulseMs = pulseMs / 2; ratio = interval / pulseMs; }

            if (ratio >= 3.2) return { name: "Semibreve", icon: "洧" };
            if (ratio >= 1.6) return { name: "M칤nima", icon: "洧" };
            if (ratio >= 0.7) {
                pulseMs = (pulseMs * 0.8) + (interval * 0.2); // Ajuste leve do BPM
                return { name: "Sem칤nima", icon: "洧" };
            }
            return { name: "Colcheia", icon: "洧" };
        }

        function updateTonality() {
            if (harmonyHistory.length < 5) return;

            let bestScale = currentTonality;
            let maxScore = 0;

            diatonicScales.forEach((scale, root) => {
                const score = harmonyHistory.filter(n => scale.includes(n)).length;
                if (score > maxScore) {
                    maxScore = score;
                    bestScale = root;
                }
            });

            currentTonality = bestScale;
            elements.key.innerText = cipherNames[currentTonality];
        }

        function updateChord(note) {
            const degree = (note - currentTonality + 12) % 12;
            const field = {
                0: cipherNames[currentTonality],               // I
                2: cipherNames[(currentTonality + 2) % 12] + "m",    // ii
                4: cipherNames[(currentTonality + 4) % 12] + "m",    // iii
                5: cipherNames[(currentTonality + 5) % 12],        // IV
                7: cipherNames[(currentTonality + 7) % 12],        // V
                9: cipherNames[(currentTonality + 9) % 12] + "m",    // vi
                11: cipherNames[(currentTonality + 11) % 12] + "췈"  // vii췈
            };

            const chord = field[degree] || cipherNames[note];
            elements.chord.innerText = chord;

            // Feedback visual
            elements.chord.style.color = "#fff";
            setTimeout(() => elements.chord.style.color = "var(--chord-color)", 200);
        }

        function updateTuner(pitch, noteNum) {
            const targetFreq = 440 * Math.pow(2, (noteNum - 69) / 12);
            const cents = Math.floor(1200 * Math.log2(pitch / targetFreq));
            let pos = 50 + (cents * 0.5);
            pos = Math.max(5, Math.min(95, pos));
            elements.indicator.style.left = pos + "%";
            elements.indicator.style.background = Math.abs(cents) < 10 ? "#1db954" : "var(--accent-color)";
        }
    </script>
</body>
</html>