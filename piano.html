<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Harmony Detector</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .display-container {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: #1e1e1e;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            min-width: 350px;
            border: 1px solid #333;
        }

        #current-chord {
            font-size: 72px;
            font-weight: 800;
            color: #00ffcc;
            margin: 10px 0;
            height: 85px;
            text-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }

        #current-key {
            font-size: 20px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .piano {
            display: flex;
            background: #000;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .key {
            width: 55px;
            height: 200px;
            background: white;
            border: 1px solid #bbb;
            border-radius: 0 0 6px 6px;
            position: relative;
            transition: all 0.05s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
            color: #333;
            font-weight: bold;
            user-select: none;
        }

            .key.black {
                width: 38px;
                height: 125px;
                background: #222;
                color: white;
                margin-left: -19px;
                margin-right: -19px;
                z-index: 2;
                border: none;
                border-radius: 0 0 4px 4px;
            }

            .key.active {
                background: #00ffcc !important;
                height: 195px;
                transform: translateY(2px);
                box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2);
            }

            .key.black.active {
                background: #00bb99 !important;
                height: 122px;
            }

        .instructions {
            margin-top: 30px;
            color: #555;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="display-container">
        <div id="current-key">Aguardando notas...</div>
        <div id="current-chord">-</div>
    </div>

    <div class="piano">
        <div class="key" id="key-0">Z</div>
        <div class="key black" id="key-1">S</div>
        <div class="key" id="key-2">X</div>
        <div class="key black" id="key-3">D</div>
        <div class="key" id="key-4">C</div>
        <div class="key" id="key-5">V</div>
        <div class="key black" id="key-6">G</div>
        <div class="key" id="key-7">B</div>
        <div class="key black" id="key-8">H</div>
        <div class="key" id="key-9">N</div>
        <div class="key black" id="key-10">J</div>
        <div class="key" id="key-11">M</div>
    </div>

    <div class="instructions">
        Use o teclado: Z S X D C V G B H N J M | Segure várias teclas para formar acordes
    </div>

    <script>
        const cipherNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const keyMap = { 'z': 0, 's': 1, 'x': 2, 'd': 3, 'c': 4, 'v': 5, 'g': 6, 'b': 7, 'h': 8, 'n': 9, 'j': 10, 'm': 11 };

        const activeNotes = new Set();
        let history = [];
        let currentTonality = null;
        let resetTimer = null;

        const chordDisplay = document.getElementById('current-chord');
        const keyDisplay = document.getElementById('current-key');

        // Escalas Diatônicas Maiores
        const diatonicScales = Array.from({ length: 12 }, (_, root) => {
            return [0, 2, 4, 5, 7, 9, 11].map(interval => (root + interval) % 12);
        });

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap.hasOwnProperty(key) && !activeNotes.has(keyMap[key])) {
                const note = keyMap[key];
                activeNotes.add(note);
                history.push(note);
                if (history.length > 15) history.shift();

                updateUI(note, true);
                analyzeMusic();

                clearTimeout(resetTimer);
                resetTimer = setTimeout(resetPiano, 4000);
            }
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap.hasOwnProperty(key)) {
                const note = keyMap[key];
                activeNotes.delete(note);
                updateUI(note, false);
                analyzeMusic();
            }
        });

        function updateUI(note, isActive) {
            const el = document.getElementById(`key-${note}`);
            if (isActive) el.classList.add('active');
            else el.classList.remove('active');
        }

        function analyzeMusic() {
            // 1. Identificar o Tom (Escala) baseado no histórico
            updateTonality();

            // 2. Identificar Acorde baseado nas notas seguradas
            if (activeNotes.size > 0) {
                const chord = detectChord([...activeNotes]);
                chordDisplay.innerText = chord;
            } else {
                chordDisplay.innerText = "-";
            }
        }

        function updateTonality() {
            if (history.length < 3) return;

            let bestScale = currentTonality;
            let maxScore = 0;

            diatonicScales.forEach((scale, root) => {
                const score = history.filter(note => scale.includes(note)).length;
                if (score > maxScore) {
                    maxScore = score;
                    bestScale = root;
                }
            });

            // Só muda o tom se a aderência for alta para evitar oscilação
            if (maxScore > history.length * 0.7) {
                currentTonality = bestScale;
                keyDisplay.innerText = `Tom: ${cipherNames[currentTonality]}`;
            }
        }

        function detectChord(notes) {
            if (notes.length === 1) return cipherNames[notes[0]];

            notes.sort((a, b) => a - b);

            // Tenta identificar tríades em qualquer inversão
            for (let i = 0; i < notes.length; i++) {
                const root = notes[i];
                // Normaliza intervalos em relação a uma possível tônica
                const intervals = notes.map(n => (n - root + 12) % 12);

                if (intervals.includes(4) && intervals.includes(7)) return cipherNames[root]; // Maior
                if (intervals.includes(3) && intervals.includes(7)) return cipherNames[root] + "m"; // Menor
                if (intervals.includes(3) && intervals.includes(6)) return cipherNames[root] + "dim"; // Diminuto
                if (intervals.includes(4) && intervals.includes(8)) return cipherNames[root] + "aug"; // Aumentado
                if (intervals.includes(2) && intervals.includes(7)) return cipherNames[root] + "sus2";
                if (intervals.includes(5) && intervals.includes(7)) return cipherNames[root] + "sus4";
            }

            // Se não for tríade clara, mostra as notas individuais ou simplifica
            return cipherNames[notes[0]] + "...";
        }

        function resetPiano() {
            history = [];
            currentTonality = null;
            keyDisplay.innerText = "Aguardando notas...";
            chordDisplay.innerText = "-";
        }
    </script>
</body>
</html>