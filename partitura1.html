<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor de Partitura Interativo</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.5/build/cjs/vexflow.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #eef2f3;
            user-select: none; /* Evita selecionar texto ao arrastar notas */
        }

        #controls {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-save {
            background-color: #2ecc71;
            color: white;
        }

        .btn-reset {
            background-color: #e74c3c;
            color: white;
        }

        button:hover {
            opacity: 0.8;
        }

        #partitura {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            touch-action: none; /* Importante para o arrasto no mobile */
            cursor: ns-resize;
        }

        .info {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
            text-align: center;
        }
    </style>
</head>
<body>

    <h2>Editor Interativo: Arraste as Notas</h2>

    <div id="controls">
        <button class="btn-save" onclick="saveToLocal()">Salvar Partitura</button>
        <button class="btn-reset" onclick="resetData()">Resetar Padrão</button>
    </div>

    <div id="partitura"></div>

    <p class="info">Clique ou toque em uma nota e arraste para cima ou para baixo para mudar o tom.</p>

    <script>
        const { Renderer, Stave, StaveNote, Voice, Formatter, ChordSymbol, BarNote, Annotation } = Vex.Flow;
        const partituraDiv = document.getElementById('partitura');

        // Configurações e Dados
        let musicData = [];
        const STORAGE_KEY = 'minha_partitura_vexflow';
        const PITCHES = ["c/6", "b/5", "a/5", "g/5", "f/5", "e/5", "d/5", "c/5", "b/4", "a/4", "g/4", "f/4", "e/4", "d/4", "c/4", "b/3", "a/3", "g/3"];

        // Variáveis de controle de drag
        let isDragging = false;
        let selectedNoteIndex = null;
        let startY = 0;

        const defaultData = [
            { "chord": "D", "notes": ["d/4"], "lyric": "Bem" },
            { "notes": ["d/4"], "lyric": "vin-" },
            { "notes": ["e/4"], "lyric": "dos" },
            { "chord": "Bm", "notes": ["b/3"], "lyric": "ao", "bar": true },
            { "chord": "G", "notes": ["g/3"], "lyric": "meu" },
            { "chord": "A7", "notes": ["a/3"], "lyric": "som." }
        ];

        // Inicialização
        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            musicData = saved ? JSON.parse(saved) : defaultData;
            drawMusic();
            setupInteractions();
        };

        function drawMusic() {
            partituraDiv.innerHTML = '';
            const renderer = new Renderer(partituraDiv, Renderer.Backends.SVG);
            const width = Math.max(600, musicData.length * 100);
            renderer.resize(width, 300);
            const context = renderer.getContext();

            const stave = new Stave(10, 60, width - 20);
            stave.addClef("treble").addTimeSignature("4/4");
            stave.setContext(context).draw();

            const tickables = musicData.flatMap((item, index) => {
                const note = new StaveNote({
                    keys: item.notes,
                    duration: "q",
                });

                // Esconder haste
                if (note.getStem()) note.getStem().hide = true;

                // Cifra
                if (item.chord) {
                    note.addModifier(new ChordSymbol().setFont('Arial', 12, 'bold').addText(item.chord));
                }

                // Letra
                if (item.lyric) {
                    note.addModifier(new Annotation(item.lyric)
                        .setFont('Serif', 12, 'italic')
                        .setVerticalJustification(Annotation.VerticalJustify.BOTTOM));
                }

                return item.bar ? [note, new BarNote()] : [note];
            });

            const voice = new Voice({ num_beats: musicData.length, beat_value: 4 });
            voice.addTickables(tickables);
            new Formatter().joinVoices([voice]).format([voice], width - 100);
            voice.draw(context, stave);
        }

        // Lógica de Interatividade (Drag and Drop)
        function setupInteractions() {
            const handleStart = (e) => {
                const pos = getMousePos(e);
                // Encontrar qual nota está mais perto do clique no eixo X
                // Como as notas estão distribuídas, dividimos a largura pelo total
                const rect = partituraDiv.getBoundingClientRect();
                const xRelativo = pos.x - rect.left;

                // Estimativa simples de qual nota foi clicada baseada na posição X
                selectedNoteIndex = Math.floor((xRelativo / rect.width) * musicData.length);
                if (selectedNoteIndex >= 0 && selectedNoteIndex < musicData.length) {
                    isDragging = true;
                    startY = pos.y;
                }
            };

            const handleMove = (e) => {
                if (!isDragging) return;
                e.preventDefault(); // Previne scroll no mobile ao arrastar

                const pos = getMousePos(e);
                const diffY = pos.y - startY;

                // Sensibilidade: a cada 10 pixels de movimento, mudamos a nota
                if (Math.abs(diffY) > 10) {
                    const direction = diffY > 0 ? 1 : -1;
                    updateNotePitch(selectedNoteIndex, direction);
                    startY = pos.y; // Reseta o ponto inicial para o próximo "degrau"
                    drawMusic();
                }
            };

            const handleEnd = () => {
                isDragging = false;
                selectedNoteIndex = null;
            };

            // Mouse
            partituraDiv.addEventListener('mousedown', handleStart);
            window.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);

            // Touch
            partituraDiv.addEventListener('touchstart', handleStart);
            window.addEventListener('touchmove', handleMove, { passive: false });
            window.addEventListener('touchend', handleEnd);
        }

        function getMousePos(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX, y: clientY };
        }

        function updateNotePitch(index, direction) {
            const currentPitch = musicData[index].notes[0];
            const pitchIndex = PITCHES.indexOf(currentPitch);

            // direction 1 = descer (aumentar index no array PITCHES), direction -1 = subir
            let newIndex = pitchIndex + direction;

            if (newIndex >= 0 && newIndex < PITCHES.length) {
                musicData[index].notes = [PITCHES[newIndex]];
            }
        }

        // Funções de Persistência
        function saveToLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(musicData));
            alert("Partitura salva com sucesso!");
        }

        function resetData() {
            if (confirm("Deseja resetar para a partitura padrão?")) {
                musicData = JSON.parse(JSON.stringify(defaultData));
                localStorage.removeItem(STORAGE_KEY);
                drawMusic();
            }
        }
    </script>
</body>
</html>