<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor de Partitura Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
        }

        #header {
            padding: 10px;
            background: #333;
            color: white;
            width: 100%;
            text-align: center;
            font-size: 14px;
        }

        /* Container principal: Partitura + Barra Lateral */
        .editor-container {
            display: flex;
            align-items: flex-start;
            margin-top: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #score-container {
            cursor: pointer;
        }

        /* Barra de ferramentas lateral */
        .side-toolbar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-left: 10px;
            margin-top: 30px; /* Alinhado mais ou menos com a pauta */
        }

        /* Botões Quadrados/Retangulares */
        .tool-btn {
            width: 50px;
            height: 50px;
            background: #ffffff;
            border: 2px solid #333;
            border-radius: 4px; /* Quadrado com leve arredondamento */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: background 0.2s;
        }

            .tool-btn:active {
                background: #e0e0e0;
                transform: scale(0.95);
            }

        .btn-add {
            color: #2e7d32;
            font-size: 24px;
            font-weight: bold;
        }

        .btn-delete {
            color: #c62828;
        }

            /* Ajuste do tamanho do SVG dentro do botão */
            .btn-delete svg {
                width: 30px;
                height: 30px;
            }
    </style>
</head>
<body>

    <div id="header">
        Editor Musical: Arraste as notas para editar
    </div>

    <div class="editor-container">
        <!-- Partitura -->
        <div id="score-container"></div>

        <!-- Barra Lateral de Botões -->
        <div class="side-toolbar">
            <!-- Botão Adicionar -->
            <button class="tool-btn btn-add" onclick="addNewNote()" title="Adicionar Nota">+♪</button>

            <!-- Botão Apagar Última (SVG) -->
            <button class="tool-btn btn-delete" onclick="deleteLastNote()" title="Apagar Última">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-backspace" viewBox="0 0 16 16">
                    <path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708l2.147-2.147 2.146 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.146-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z" />
                    <path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1zm-7.08 1a1 1 0 0 0-.76.35L1 8l4.844 5.65a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        const { Renderer, Stave, StaveNote, Voice, Formatter } = Vex.Flow;

        const container = document.getElementById('score-container');
        const width = window.innerWidth * 0.75;
        const height = 200;

        let notesData = [{ key: "b/4", duration: "q" }];
        let noteXPositions = [];
        let isDragging = false;
        let selectedNoteIndex = -1;

        const basePitches = ["c/4", "d/4", "e/4", "f/4", "g/4", "a/4", "b/4", "c/5", "d/5", "e/5", "f/5", "g/5", "a/5"];

        function draw() {
            container.innerHTML = "";
            const renderer = new Renderer(container, Renderer.Backends.SVG);
            renderer.resize(width, height);
            const context = renderer.getContext();

            const stave = new Stave(10, 40, width - 20);
            stave.addClef("treble").addTimeSignature("4/4");
            stave.setContext(context).draw();

            const vexNotes = notesData.map((data, index) => {
                const note = new StaveNote({ keys: [data.key], duration: data.duration });
                if (index === selectedNoteIndex) {
                    note.setStyle({ fillStyle: "red", strokeStyle: "red" });
                }
                return note;
            });

            if (vexNotes.length > 0) {
                const voice = new Voice({ num_beats: vexNotes.length, beat_value: 4 });
                voice.setStrict(false);
                voice.addTickables(vexNotes);
                new Formatter().joinVoices([voice]).format([voice], width - 50);
                voice.draw(context, stave);
                noteXPositions = vexNotes.map(n => n.getAbsoluteX());
            }
        }

        function getYToPitch(y) {
            const centerY = 90;
            const stepHeight = 5;
            const diff = Math.round((centerY - y) / stepHeight);
            const b4Index = 6;
            let newIndex = b4Index + diff;
            newIndex = Math.max(0, Math.min(newIndex, basePitches.length - 1));
            return basePitches[newIndex];
        }

        function addNewNote() {
            notesData.push({ key: "b/4", duration: "q" });
            draw();
        }

        function deleteLastNote() {
            if (notesData.length > 0) {
                notesData.pop();
                draw();
            }
        }

        function handleStart(e) {
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = clientX - rect.left;

            let foundIndex = -1;
            for (let i = 0; i < noteXPositions.length; i++) {
                if (Math.abs(x - noteXPositions[i]) < 25) {
                    foundIndex = i;
                    break;
                }
            }

            if (foundIndex !== -1) {
                selectedNoteIndex = foundIndex;
                isDragging = true;
                draw();
            }
        }

        function handleMove(e) {
            if (!isDragging || selectedNoteIndex === -1) return;
            e.preventDefault();
            const rect = container.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const y = clientY - rect.top;

            const newPitch = getYToPitch(y);
            if (notesData[selectedNoteIndex].key !== newPitch) {
                notesData[selectedNoteIndex].key = newPitch;
                draw();
            }
        }

        function handleEnd() {
            isDragging = false;
            selectedNoteIndex = -1;
            draw();
        }

        container.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        container.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('touchend', handleEnd);

        draw();
    </script>
</body>
</html>