<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Harmony & Rhythm History</title>
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ffcc00;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1000px;
        }

        .display-container {
            text-align: center;
            padding: 20px;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            min-width: 250px;
            border: 1px solid #333;
        }

        #current-chord {
            font-size: 58px;
            font-weight: 800;
            color: var(--primary);
            margin: 5px 0;
            height: 70px;
        }

        .bpm-value {
            font-size: 58px;
            font-weight: 800;
            color: var(--secondary);
            margin: 5px 0;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .history-panel {
            background: var(--card);
            border-radius: 20px;
            width: 300px;
            height: 250px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .history-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #252525;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .history-note {
            color: var(--primary);
            font-weight: bold;
            font-size: 16px;
        }

        .history-rhythm {
            color: var(--secondary);
        }

        .history-time {
            color: #666;
            font-size: 11px;
        }

        .piano {
            display: flex;
            background: #000;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .key {
            width: 45px;
            height: 160px;
            background: white;
            border: 1px solid #bbb;
            border-radius: 0 0 5px 5px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

            .key.black {
                width: 30px;
                height: 100px;
                background: #222;
                color: white;
                margin-left: -15px;
                margin-right: -15px;
                z-index: 2;
                border: none;
            }

            .key.active {
                background: var(--primary) !important;
                height: 155px;
                transform: translateY(2px);
            }

            .key.black.active {
                background: #00bb99 !important;
                height: 98px;
            }

        .instructions {
            margin-top: 20px;
            color: #555;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="main-layout">
        <div class="display-container">
            <div class="stat-label" id="current-key">Aguardando...</div>
            <div id="current-chord">-</div>
            <div class="stat-label">Acorde Atual</div>
        </div>

        <div class="display-container">
            <div class="stat-label">BPM Estimado</div>
            <div id="bpm-display" class="bpm-value">0</div>
            <div class="stat-label" id="last-note-type">Pulsa√ß√£o Din√¢mica</div>
        </div>

        <div class="history-panel">
            <div class="stat-label">Hist√≥rico de Notas</div>
            <div id="history-list" class="history-list"></div>
        </div>
    </div>

    <div class="piano">
        <div class="key" id="key-0">Z</div>
        <div class="key black" id="key-1">S</div>
        <div class="key" id="key-2">X</div>
        <div class="key black" id="key-3">D</div>
        <div class="key" id="key-4">C</div>
        <div class="key" id="key-5">V</div>
        <div class="key black" id="key-6">G</div>
        <div class="key" id="key-7">B</div>
        <div class="key black" id="key-8">H</div>
        <div class="key" id="key-9">N</div>
        <div class="key black" id="key-10">J</div>
        <div class="key" id="key-11">M</div>
    </div>

    <div class="instructions">
        <b>Semibreve:</b> Toque uma nota e aguarde um longo tempo (4x o pulso base) antes da pr√≥xima nota.<br>
        A primeira nota tocada define o tempo de uma Sem√≠nima.
    </div>

    <script>
        const cipherNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const keyMap = { 'z': 0, 's': 1, 'x': 2, 'd': 3, 'c': 4, 'v': 5, 'g': 6, 'b': 7, 'h': 8, 'n': 9, 'j': 10, 'm': 11 };
        const diatonicScales = Array.from({ length: 12 }, (_, root) => [0, 2, 4, 5, 7, 9, 11].map(i => (root + i) % 12));

        const activeNotes = new Set();
        let harmonyHistory = [];
        let currentTonality = null;

        // R√≠tmico
        let lastNoteTime = 0;
        let pulseMs = 0;

        const chordDisplay = document.getElementById('current-chord');
        const keyDisplay = document.getElementById('current-key');
        const bpmDisplay = document.getElementById('bpm-display');
        const historyList = document.getElementById('history-list');
        const lastNoteTypeDisplay = document.getElementById('last-note-type');

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap.hasOwnProperty(key) && !activeNotes.has(keyMap[key])) {
                const noteIndex = keyMap[key];
                const now = Date.now();

                const rhythmData = processRhythm(now);
                if (rhythmData) addNoteToHistory(cipherNames[noteIndex], rhythmData);

                activeNotes.add(noteIndex);
                harmonyHistory.push(noteIndex);
                if (harmonyHistory.length > 15) harmonyHistory.shift();

                updateUI(noteIndex, true);
                analyzeHarmony();
            }
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap.hasOwnProperty(key)) {
                const noteIndex = keyMap[key];
                activeNotes.delete(noteIndex);
                updateUI(noteIndex, false);
                analyzeHarmony();
            }
        });

        function processRhythm(now) {
            let result = { name: "In√≠cio", icon: "‚ñ∂" };

            if (lastNoteTime > 0) {
                const interval = now - lastNoteTime;

                // Ignora press√µes quase simult√¢neas (acordes) para n√£o quebrar o ritmo
                if (interval < 50) return null;

                // Se demorar mais de 5 segundos, reseta o pulso
                if (interval > 5000) {
                    pulseMs = 0;
                    result = { name: "Novo In√≠cio", icon: "‚ñ∂" };
                } else {
                    result = classifyNote(interval);
                    bpmDisplay.innerText = Math.round(60000 / pulseMs);
                    lastNoteTypeDisplay.innerText = `${result.icon} ${result.name}`;
                }
            }
            lastNoteTime = now;
            return result;
        }

        function classifyNote(interval) {
            if (pulseMs === 0) {
                pulseMs = interval;
                return { name: "Sem√≠nima", icon: "ùÖü" };
            }

            let ratio = interval / pulseMs;

            // Se for muito r√°pido, ajusta a escala (o que era sem√≠nima vira m√≠nima)
            if (ratio < 0.3) {
                pulseMs = pulseMs / 2;
                ratio = interval / pulseMs;
            }

            // L√≥gica de classifica√ß√£o incluindo Semibreve
            if (ratio >= 3.3) return { name: "Semibreve", icon: "ùÖù" }; // ~4 tempos
            if (ratio >= 1.7) return { name: "M√≠nima", icon: "ùÖû" };    // ~2 tempos
            if (ratio >= 0.75) return { name: "Sem√≠nima", icon: "ùÖü" };  // ~1 tempo
            if (ratio >= 0.35) return { name: "Colcheia", icon: "ùÖ†" };   // ~0.5 tempo
            return { name: "Semicolcheia", icon: "ùÖ°" };               // ~0.25 tempo
        }

        function addNoteToHistory(noteName, rhythm) {
            const item = document.createElement('div');
            item.className = 'history-item';
            const timeStr = new Date().toLocaleTimeString([], { hour12: false, minute: '2-digit', second: '2-digit' });

            item.innerHTML = `
                    <span class="history-note">${noteName}</span>
                    <span class="history-rhythm">${rhythm.icon} ${rhythm.name}</span>
                    <span class="history-time">${timeStr}</span>
                `;

            historyList.prepend(item);
            if (historyList.children.length > 30) historyList.removeChild(historyList.lastChild);
        }

        function analyzeHarmony() {
            if (harmonyHistory.length >= 3) {
                let bestScale = currentTonality;
                let maxScore = 0;
                diatonicScales.forEach((scale, root) => {
                    const score = harmonyHistory.filter(n => scale.includes(n)).length;
                    if (score > maxScore) { maxScore = score; bestScale = root; }
                });
                if (maxScore > harmonyHistory.length * 0.7) {
                    currentTonality = bestScale;
                    keyDisplay.innerText = `Tom: ${cipherNames[currentTonality]}`;
                }
            }
            chordDisplay.innerText = activeNotes.size > 0 ? detectChord([...activeNotes]) : "-";
        }

        function detectChord(notes) {
            if (notes.length === 1) return cipherNames[notes[0]];
            notes.sort((a, b) => a - b);
            for (let i = 0; i < notes.length; i++) {
                const root = notes[i];
                const intervals = notes.map(n => (n - root + 12) % 12);
                if (intervals.includes(4) && intervals.includes(7)) return cipherNames[root];
                if (intervals.includes(3) && intervals.includes(7)) return cipherNames[root] + "m";
                if (intervals.includes(3) && intervals.includes(6)) return cipherNames[root] + "dim";
                if (intervals.includes(2) && intervals.includes(7)) return cipherNames[root] + "sus2";
                if (intervals.includes(5) && intervals.includes(7)) return cipherNames[root] + "sus4";
            }
            return cipherNames[notes[0]] + "...";
        }

        function updateUI(note, isActive) {
            const el = document.getElementById(`key-${note}`);
            if (el) {
                if (isActive) el.classList.add('active');
                else el.classList.remove('active');
            }
        }
    </script>
</body>
</html>