<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Detector Pro</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --success: #10b981;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: var(--card);
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 450px;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .tagline {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-bottom: 2rem;
        }

        /* Display de Nota */
        #note-display {
            font-size: 6rem;
            font-weight: 900;
            color: var(--primary);
            margin: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .freq-info {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-sub);
            margin-bottom: 1.5rem;
        }

        /* Medidor de Afinação */
        .tuner-container {
            position: relative;
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            margin: 2rem 0;
            overflow: visible;
        }

        .center-line {
            position: absolute;
            left: 50%;
            width: 2px;
            height: 20px;
            background: var(--success);
            top: -4px;
            z-index: 1;
        }

        #needle {
            position: absolute;
            left: 50%;
            width: 4px;
            height: 20px;
            background: var(--primary);
            top: -4px;
            border-radius: 2px;
            transform: translateX(-50%);
            transition: left 0.1s ease-out;
            z-index: 2;
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.4);
        }

        /* Painel de Controles */
        .settings-panel {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 16px;
            text-align: left;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        .control-group {
            margin-bottom: 1rem;
        }

            .control-group:last-child {
                margin-bottom: 0;
            }

        label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 0.4rem;
        }

            label span {
                color: var(--primary);
            }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        /* Botão */
        .main-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

            .main-btn:hover {
                background: #4338ca;
                transform: translateY(-2px);
            }

            .main-btn.active {
                background: #ef4444;
            }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #cbd5e1;
            border-radius: 50%;
            margin-right: 5px;
        }

            .status-dot.on {
                background: #ef4444;
                animation: pulse 1s infinite;
            }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Pitch Detector Pro</h1>
        <p class="tagline"><span id="dot" class="status-dot"></span> <span id="status-text">Microfone inativo</span></p>

        <div id="note-display">--</div>
        <div class="freq-info"><span id="frequency">0.00</span> Hz</div>

        <div class="tuner-container">
            <div class="center-line"></div>
            <div id="needle"></div>
        </div>

        <div class="settings-panel">
            <div class="control-group">
                <label>Sensibilidade (Noise): <span id="v-noise">0.02</span></label>
                <input type="range" id="noise" min="0.001" max="0.1" step="0.001" value="0.02">
            </div>
            <div class="control-group">
                <label>Freq. Mínima: <span id="v-min">80</span> Hz</label>
                <input type="range" id="min-freq" min="40" max="200" step="1" value="80">
            </div>
            <div class="control-group">
                <label>Freq. Máxima: <span id="v-max">1100</span> Hz</label>
                <input type="range" id="max-freq" min="500" max="2000" step="10" value="1100">
            </div>
            <div class="control-group">
                <label>Suavização (Smoothing): <span id="v-smooth">5</span></label>
                <input type="range" id="smooth" min="1" max="20" step="1" value="5">
            </div>
            <div class="control-group">
                <label>Duração Mínima: <span id="v-duration">100</span> ms</label>
                <input type="range" id="duration" min="0" max="1000" step="50" value="100">
            </div>
        </div>

        <button id="start-btn" class="main-btn">Iniciar Detecção</button>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const config = {
            noiseThreshold: 0.02,
            minFreq: 80,
            maxFreq: 1100,
            smoothing: 5,
            minDuration: 100
        };

        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        // --- ESTADO ---
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let isRunning = false;
        let pitchHistory = [];
        let lastDetectedNoteName = "";
        let noteStartTime = 0;

        // --- ELEMENTOS UI ---
        const ui = {
            btn: document.getElementById('start-btn'),
            note: document.getElementById('note-display'),
            freq: document.getElementById('frequency'),
            needle: document.getElementById('needle'),
            dot: document.getElementById('dot'),
            status: document.getElementById('status-text'),
            inNoise: document.getElementById('noise'),
            inMin: document.getElementById('min-freq'),
            inMax: document.getElementById('max-freq'),
            inSmooth: document.getElementById('smooth'),
            inDuration: document.getElementById('duration'),
            lNoise: document.getElementById('v-noise'),
            lMin: document.getElementById('v-min'),
            lMax: document.getElementById('v-max'),
            lSmooth: document.getElementById('v-smooth'),
            lDuration: document.getElementById('v-duration')
        };

        // --- ATUALIZAÇÃO DE CONFIGURAÇÕES ---
        const updateConfigs = () => {
            config.noiseThreshold = parseFloat(ui.inNoise.value);
            config.minFreq = parseInt(ui.inMin.value);
            config.maxFreq = parseInt(ui.inMax.value);
            config.smoothing = parseInt(ui.inSmooth.value);
            config.minDuration = parseInt(ui.inDuration.value);

            ui.lNoise.innerText = config.noiseThreshold;
            ui.lMin.innerText = config.minFreq;
            ui.lMax.innerText = config.maxFreq;
            ui.lSmooth.innerText = config.smoothing;
            ui.lDuration.innerText = config.minDuration;
        };

        [ui.inNoise, ui.inMin, ui.inMax, ui.inSmooth, ui.inDuration].forEach(el => el.oninput = updateConfigs);

        // --- LOGICA DE ÁUDIO ---
        ui.btn.onclick = async () => {
            if (isRunning) { location.reload(); return; }

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                dataArray = new Float32Array(analyser.fftSize);

                isRunning = true;
                ui.btn.innerText = "Parar Detecção";
                ui.btn.classList.add('active');
                ui.dot.classList.add('on');
                ui.status.innerText = "Capturando áudio...";

                update();
            } catch (err) {
                alert("Erro: Permita o acesso ao microfone.");
            }
        };

        function update() {
            if (!isRunning) return;

            analyser.getFloatTimeDomainData(dataArray);
            let pitch = autoCorrelate(dataArray, audioContext.sampleRate);

            if (pitch !== -1 && pitch >= config.minFreq && pitch <= config.maxFreq) {
                const rawNoteData = getNote(pitch);
                const now = performance.now();

                if (rawNoteData.name !== lastDetectedNoteName) {
                    lastDetectedNoteName = rawNoteData.name;
                    noteStartTime = now;
                }

                if (now - noteStartTime >= config.minDuration) {
                    pitchHistory.push(pitch);
                    if (pitchHistory.length > config.smoothing) pitchHistory.shift();

                    const avgPitch = pitchHistory.reduce((a, b) => a + b) / pitchHistory.length;
                    const noteData = getNote(avgPitch);

                    ui.note.innerText = noteData.name;
                    ui.freq.innerText = avgPitch.toFixed(2);
                    ui.needle.style.left = `${50 + noteData.cents}%`;
                    ui.note.style.color = Math.abs(noteData.cents) < 10 ? "var(--success)" : "var(--primary)";
                }
            } else {
                lastDetectedNoteName = ""; // Reseta se houver silêncio
                if (pitchHistory.length > 0) pitchHistory.shift();
            }

            requestAnimationFrame(update);
        }

        // Algoritmo de Autocorrelação (AMDF adaptado)
        function autoCorrelate(buffer, sampleRate) {
            let rms = 0;
            for (let i = 0; i < buffer.length; i++) rms += buffer[i] * buffer[i];
            rms = Math.sqrt(rms / buffer.length);
            if (rms < config.noiseThreshold) return -1;

            let minPeriod = sampleRate / config.maxFreq;
            let maxPeriod = sampleRate / config.minFreq;

            let bestOffset = -1;
            let bestCorrelation = 0;

            for (let offset = Math.floor(minPeriod); offset < Math.ceil(maxPeriod); offset++) {
                let correlation = 0;
                for (let i = 0; i < buffer.length - offset; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / buffer.length);
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }

            if (bestCorrelation > 0.9) {
                return sampleRate / bestOffset;
            }
            return -1;
        }

        function getNote(frequency) {
            const minNote = 69; // A4
            const minFreq = 440;
            const semitones = 12 * Math.log2(frequency / minFreq);
            const noteNum = Math.round(semitones) + minNote;
            const cents = Math.floor((semitones - Math.round(semitones)) * 100);
            return { name: noteStrings[noteNum % 12], cents: cents };
        }
    </script>
</body>
</html>